<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Chat ‚Ä¢ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.min.js"></script>
</head>
<body data-user-id="{{ user_id|default('') }}">
    <style>
        /* ----------------- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò ----------------- */
    </style>
    <div class="chat-app">
        <!-- –°–∞–π–¥–±–∞—Ä -->
        <div class="sidebar">
            <!-- –®–∞–ø–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar">
                        {{ username[0]|upper }}
                    </div>
                    <div class="user-details">
                        <h3>{{ username }}</h3>
                        <p>Online</p>
                    </div>
                </div>
                <a href="/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
            </div>

            <!-- –ü–æ–∏—Å–∫ –¥—Ä—É–∑–µ–π -->
            <div class="search-section">
                <h4>–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</h4>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ email –∏–ª–∏ –∏–º—è...">
                    <button id="search-btn">+</button>
                </div>
                <div id="search-result"></div>
            </div>

            <!-- –í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏ -->
            {% if incoming_requests %}
            <div class="requests-section">
                <h4>–ó–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è</h4>
                {% for user, request in incoming_requests %}
                <div class="friend-request">
                    <div class="request-info">
                        <div class="request-avatar">{{ user.username[0]|upper }}</div>
                        <div>
                            <strong>{{ user.username }}</strong>
                            <p>–•–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å</p>
                        </div>
                    </div>
                    <div class="request-actions">
                        <button class="request-action" data-request-id="{{ request.id }}" data-action="accept" title="–ü—Ä–∏–Ω—è—Ç—å">‚úì</button>
                        <button class="request-action" data-request-id="{{ request.id }}" data-action="decline" title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å">‚úó</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π -->
            <div class="friends-section">
                <h4>–î—Ä—É–∑—å—è</h4>
                {% if friends %}
                    {% for friend in friends %}
                    <div class="friend" data-id="{{ friend.id }}" data-username="{{ friend.username }}">
                        <div class="friend-avatar">{{ friend.username[0]|upper }}</div>
                        <div class="friend-info">
                            <h4>{{ friend.username }}</h4>
                            <p>–í —Å–µ—Ç–∏</p>
                        </div>
                        <div class="online-dot"></div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div>üë•</div>
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</p>
                        <small>–ù–∞–π–¥–∏—Ç–µ –¥—Ä—É–∑–µ–π —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-avatar" id="current-friend-avatar">?</div>
                <div class="chat-info">
                    <h3 id="current-friend-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                    <p id="current-friend-status">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</p>
                </div>
            </div>

            <div class="messages-container" id="messages">
                <div class="empty-state">
                    <div>üí¨</div>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è</p>
                    <small>–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</small>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="chat-input" 
                        placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                        rows="1"
                        disabled
                    ></textarea>
                    <button id="send-btn" disabled>
                        <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
     // static/chat.js - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
class ChatApp {
    constructor() {
        this.socket = io();
        this.currentReceiverId = null;
        this.currentReceiverName = null;
        this.userId = parseInt(document.body.dataset.userId, 10) || null;
        this.messageQueue = new Set(); // –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        
        this.init();
    }

    init() {
        this.bindEvents();
        this.joinUserRoom();
        console.log('‚úÖ –ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }

    bindEvents() {
        // –í—ã–±–æ—Ä –¥—Ä—É–≥–∞
        document.addEventListener('click', (e) => {
            const friendEl = e.target.closest('.friend');
            if (friendEl) this.selectFriend(friendEl);
            
            const requestBtn = e.target.closest('.request-action');
            if (requestBtn) this.handleRequestAction(requestBtn);
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('send-btn').addEventListener('click', () => this.sendMessage());
        
        // –ü–æ–∏—Å–∫ –¥—Ä—É–≥–∞
        document.getElementById('search-btn').addEventListener('click', () => this.searchFriend());

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        this.setupKeyboardHandlers();
        
        // Socket events
        this.socket.on('receive_message', (data) => this.handleReceivedMessage(data));
        this.socket.on('connect', () => console.log('‚úÖ Socket –ø–æ–¥–∫–ª—é—á–µ–Ω'));
        this.socket.on('disconnect', () => console.log('‚ùå Socket –æ—Ç–∫–ª—é—á–µ–Ω'));
    }

    setupKeyboardHandlers() {
        const chatInput = document.getElementById('chat-input');
        const searchInput = document.getElementById('search-input');

        // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        // Enter –¥–ª—è –ø–æ–∏—Å–∫–∞
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.searchFriend();
            }
        });

        // –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞ textarea
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
        });
    }

    joinUserRoom() {
        if (this.userId) {
            this.socket.emit('join', { room: this.userId });
        }
    }

    selectFriend(friendEl) {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
        document.querySelectorAll('.friend').forEach(f => f.classList.remove('active'));
        friendEl.classList.add('active');
        
        this.currentReceiverId = parseInt(friendEl.dataset.id, 10);
        this.currentReceiverName = friendEl.dataset.username;
        
        this.updateChatHeader();
        this.enableInput();
        this.loadMessages(this.currentReceiverId);
    }

    updateChatHeader() {
        document.getElementById('current-friend-name').textContent = this.currentReceiverName;
        document.getElementById('current-friend-avatar').textContent = this.currentReceiverName[0].toUpperCase();
        document.getElementById('current-friend-status').textContent = '–í —Å–µ—Ç–∏';
    }

    enableInput() {
        const input = document.getElementById('chat-input');
        const button = document.getElementById('send-btn');
        
        input.disabled = false;
        button.disabled = false;
        input.focus();
    }

    sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message || !this.currentReceiverId) return;

        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
        const messageId = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        this.messageQueue.add(messageId);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
        this.displayMessage({
            message: message,
            timestamp: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'}),
            tempId: messageId
        }, 'sent', true);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        this.socket.emit('send_message', {
            message: message,
            receiver_id: this.currentReceiverId,
            sender_id: this.userId,
            tempId: messageId
        });

        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        input.value = '';
        input.style.height = 'auto';
    }

    handleReceivedMessage(data) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É
        if (!this.currentReceiverId) return;
        if (this.currentReceiverId !== data.sender_id && this.currentReceiverId !== data.receiver_id) return;

        const type = data.sender_id === this.userId ? 'sent' : 'received';
        
        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º ID, –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ
        if (type === 'sent' && data.tempId) {
            this.replaceTempMessage(data.tempId, data);
            this.messageQueue.delete(data.tempId);
        } else {
            this.displayMessage(data, type, false);
        }
    }

    replaceTempMessage(tempId, realMessage) {
        const tempElement = document.querySelector(`[data-temp-id="${tempId}"]`);
        if (tempElement) {
            tempElement.remove();
        }
        this.displayMessage(realMessage, 'sent', false);
    }

    displayMessage(data, type, isTemporary = false) {
        const messagesDiv = document.getElementById('messages');
        
        // –£–±–∏—Ä–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–ø—É—Å—Ç–æ"
        const emptyState = messagesDiv.querySelector('.empty-state');
        if (emptyState) emptyState.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        if (isTemporary) {
            messageDiv.setAttribute('data-temp-id', data.tempId);
            messageDiv.style.opacity = '0.7';
        }

        const time = data.timestamp || new Date().toLocaleTimeString('ru-RU', {
            hour: '2-digit', 
            minute: '2-digit'
        });

        messageDiv.innerHTML = `
            <div class="message-bubble">
                <div class="message-text">${this.escapeHtml(data.message)}</div>
                <div class="message-time">${time} ${isTemporary ? '‚è≥' : ''}</div>
            </div>
        `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async loadMessages(friendId) {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '<div class="empty-state"><div>üí¨</div><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p></div>';

        try {
            const response = await fetch(`/messages/${friendId}`);
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            
            const data = await response.json();
            
            if (data.error) {
                messagesDiv.innerHTML = `<div class="empty-state"><div>‚ö†Ô∏è</div><p>${data.error}</p></div>`;
                return;
            }

            messagesDiv.innerHTML = '';
            
            if (data.length === 0) {
                messagesDiv.innerHTML = `
                    <div class="empty-state">
                        <div>üí¨</div>
                        <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                        <small>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</small>
                    </div>
                `;
                return;
            }

            data.forEach(msg => {
                const type = msg.sender_id === this.userId ? 'sent' : 'received';
                this.displayMessage(msg, type, false);
            });

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            messagesDiv.innerHTML = `
                <div class="empty-state">
                    <div>‚ö†Ô∏è</div>
                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                </div>
            `;
        }
    }

    async searchFriend() {
        const searchInput = document.getElementById('search-input');
        const searchTerm = searchInput.value.trim();
        const resultDiv = document.getElementById('search-result');

        if (!searchTerm) {
            resultDiv.innerHTML = '<p class="error">–í–≤–µ–¥–∏—Ç–µ email –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>';
            return;
        }

        try {
            const response = await fetch('/search_friend', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `search_term=${encodeURIComponent(searchTerm)}`
            });

            const data = await response.json();
            
            if (data.error) {
                resultDiv.innerHTML = `<p class="error">${data.error}</p>`;
            } else {
                resultDiv.innerHTML = `<p class="success">${data.success}</p>`;
                searchInput.value = '';
                setTimeout(() => location.reload(), 1000);
            }
        } catch (error) {
            resultDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ</p>';
        }
    }

    handleRequestAction(button) {
        const requestId = parseInt(button.dataset.requestId, 10);
        const action = button.dataset.action;
        
        if (!requestId || !action) return;
        
        this.processFriendRequest(requestId, action);
    }

    async processFriendRequest(requestId, action) {
        try {
            const response = await fetch('/handle_friend_request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `request_id=${requestId}&action=${action}`
            });

            const data = await response.json();
            
            if (data.error) {
                alert(data.error);
            } else {
                alert(data.success);
                location.reload();
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏');
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    new ChatApp();
});
    </script>
</body>
</html>